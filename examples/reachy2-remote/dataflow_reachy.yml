nodes:
  - id: camera
    path: dora-reachy2-camera
    _unstable_deploy:
      machine: encoder
    inputs:
      tick: dora/timer/millis/10
    outputs:
      - image_left
      - image_depth
      - depth
    env:
      CAPTURE_PATH: 0
      IMAGE_WIDTH: 640
      IMAGE_HEIGHT: 480
      ROBOT_IP: 127.0.0.1

  - id: rav1e-local-image
    path: dora-rav1e
    build: cargo build -p dora-rav1e --release
    _unstable_deploy:
      machine: encoder
    inputs:
      image_depth: camera/image_depth
      image_left: camera/image_left
    outputs:
      - image_left
      - image_depth
      - depth
    env:
      RAV1E_SPEED: 10

  - id: dav1d-remote
    path: dora-dav1d
    build: cargo build -p dora-dav1d --release
    _unstable_deploy:
      machine: gpu
    inputs:
      image_depth: rav1e-local-image/image_depth
      image_left: rav1e-local-image/image_left
      # depth: rav1e-local/depth
    outputs:
      - image_left
      - image_depth
      - depth

  - id: dora-microphone
    build: pip install -e ../../node-hub/dora-microphone
    path: dora-microphone
    _unstable_deploy:
      machine: macbook
    inputs:
      tick: dora/timer/millis/2000
    outputs:
      - audio

  - id: dora-vad
    build: pip install -e ../../node-hub/dora-vad
    _unstable_deploy:
      machine: macbook
    path: dora-vad
    inputs:
      audio: dora-microphone/audio
    outputs:
      - audio

  - id: dora-distil-whisper
    build: pip install -e ../../node-hub/dora-distil-whisper
    _unstable_deploy:
      machine: macbook
    path: dora-distil-whisper
    inputs:
      input: dora-vad/audio
    outputs:
      - text
    env:
      TARGET_LANGUAGE: english

  - id: parse_whisper
    path: parse_whisper.py
    _unstable_deploy:
      machine: gpu
    inputs:
      text: dora-distil-whisper/text
    outputs:
      - bbox
      - action
      - points
      - text
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: dora-qwenvl
    build: pip install -e ../../node-hub/dora-qwen2-5-vl
    path: dora-qwen2-5-vl
    _unstable_deploy:
      machine: gpu
    inputs:
      image_left: dav1d-remote/image_left
      image_depth: dav1d-remote/image_depth
      text: parse_whisper/text
    outputs:
      - text
    env:
      DEFAULT_QUESTION: Output the bounding box of the suitcase.
      IMAGE_RESIZE_RATIO: "1.0"

  - id: parse_bbox
    path: parse_bbox.py
    _unstable_deploy:
      machine: gpu
    inputs:
      text: dora-qwenvl/text
      points: parse_whisper/points
    outputs:
      - bbox_track
      - bbox_grab
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: tracker
    build: pip install -e ../../node-hub/dora-cotracker
    path: dora-cotracker
    _unstable_deploy:
      machine: gpu
    inputs:
      image: dav1d-remote/image_left
      boxes2d: parse_bbox/bbox_track
    outputs:
      - tracked_image
      - points
    env:
      INTERACTIVE_MODE: false

  # - id: box_coordinates
  # build: pip install -e ../../node-hub/dora-object-to-pose
  # path: dora-object-to-pose
  # inputs:
  # depth: reachy-camera/depth
  # boxes2d: parse_bbox/bbox
  # outputs:
  # - pose
  #- id: sam2
  #build: pip install -e ../../node-hub/dora-sam2
  #path: dora-sam2
  #_unstable_deploy:
  #machine: gpu
  #inputs:
  #image_left: dav1d-remote/image_left
  #boxes2d: parse_bbox/bbox
  #outputs:
  #- masks

  - id: parse_point
    path: parse_point.py
    _unstable_deploy:
      machine: gpu
    inputs:
      points: tracker/points
    outputs:
      - action
    env:
      IMAGE_RESIZE_RATIO: "1.0"

  - id: reachy-mobile-base
    build: pip install -e ../../node-hub/dora-reachy2
    path: dora-reachy2-mobile-base
    _unstable_deploy:
      machine: encoder
    inputs:
      action_base: parse_point/action
      action_whipser: parse_whisper/action
    outputs:
      - response_base
    env:
      ROBOT_IP: 127.0.0.1

  - id: plot
    build: pip install -e ../../node-hub/dora-rerun
    path: dora-rerun
    _unstable_deploy:
      machine: macbook
    inputs:
      image: dav1d-remote/image_left
      image_depth: dav1d-remote/image_depth
      boxes2d: parse_bbox/bbox
      original_text: dora-distil-whisper/text
      parsed_text: parse_whisper/text
      qwenvl_text: dora-qwenvl/text
      tracked_image: tracker/tracked_image
